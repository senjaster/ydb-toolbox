# Скрипты для управления TLS-сертификатами YDB

В этой папке находится набор скриптов для генерации и проверки сертификатов для YDB с использованием внешнего удостоверяющего центра (CA). Скрипты помогают сгенерировать правильные запросы на подписание сертификатов (CSR), проверить готовые сертификаты и разложить их по папкам в том порядке, который ожидают Ansible-плейбуки для YDB.

## Два сценария работы

### Сценарий 1: Локальная генерация ключей (рекомендуется)

Вы генерируете закрытые ключи и CSR локально, а затем отправляете CSR в CA для подписания.

**Преимущества:** CSR позволяет четко указать требования к сертификатам

### Сценарий 2: Полная генерация в CA

Центр сертификации генерирует и ключи, и сертификаты.

**Использование:** Когда корпоративная политика требует централизованной генерации ключей.

---

## Сценарий 1: Локальная генерация ключей (рекомендуется)

Подготовка сертификатов состоит из следующих шагов:

1. **Подготовка списка узлов** - создание файла с перечнем узлов кластера
2. **Генерация CSR** - создание закрытых ключей и запросов на подписание сертификатов
3. **Получение подписанных сертификатов** - отправка CSR в ваш CA и получение готовых сертификатов
4. **Размещение сертификатов** - копирование сертификатов в правильную структуру папок
5. **Проверка сертификатов** - валидация готовых сертификатов перед развертыванием

## Файл со списком узлов

### Формат файла `ydb-ca-nodes.txt`

В файл нужно записать список узлов кластера, по одному узлу в каждой строке. Эти имена должны строго совпадать с именами узлов, указаными в inventory. Как правило, используются полные доменные имена (FQDN):

```
static-node-1.ydb-cluster.com
static-node-2.ydb-cluster.com
static-node-3.ydb-cluster.com
```

### Дополнительные имена узлов

Если узел должен быть доступен по нескольким именам, укажите их через пробел:

```
static-node-1.ydb-cluster.com node1.internal node1.backup
static-node-2.ydb-cluster.com node2.internal node2.backup
```

**Важно:** Не нужно указывать и короткое (`static-node-1`), и полное (`static-node-1.ydb-cluster.com`) имена - короткое имя автоматически извлекается из полного и добавляется в Subject Alternative Names (SAN).

## Пошаговая инструкция

### Шаг 1: Генерация CSR и закрытых ключей

Используйте скрипт `ydb_generate_csr.sh` для создания закрытых ключей и запросов на подписание сертификатов:

```bash
./ydb_generate_csr.sh -d "O=YourCompany,OU=prod-ydb-cluster"
```

**Параметры:**
- `-d` (обязательный) - **Базовый Distinguished Name (DN)**
  - Формат: компоненты DN, разделенные запятыми
  - CN (Common Name) будет автоматически добавлен для каждого узла
  - Поддерживаются как короткие (C, ST, L, O, OU), так и длинные формы (countryName, organizationName и т.д.)
  - Можно указать несколько OU (будут пронумерованы автоматически)
  
- `-c` (опциональный) - **Имя кластера** для добавления к DNS-именам
- `-f` (опциональный) - **Файл со списком узлов** (по умолчанию: ydb-ca-nodes.txt)
- `-b` (опциональный) - **Размер ключа в битах** (по умолчанию: 4096)

**Примеры использования:**

Простой DN с организацией и подразделением:
```bash
./ydb_generate_csr.sh -d "O=MyCompany,OU=prod-ydb-cluster"
```

Полный DN с географическими данными:
```bash
./ydb_generate_csr.sh -d "C=RU,ST=Moscow,L=Moscow,O=MyCompany,OU=Database Team"
```

Сложный DN с несколькими организационными подразделениями:
```bash
./ydb_generate_csr.sh -d "C=RU,ST=Saint Pitersberg,O=MyCompany,OU=Engineering,OU=Database Infrastructure"
```

**Результат выполнения:**
Скрипт создаст следующую структуру папок и файлов:
- `nodes/<узел>/node.key` - закрытый ключ для каждого узла (4096 бит)
- `nodes/<узел>/options.cnf` - конфигурационный файл OpenSSL
- `csr/<узел>.csr` - запрос на подписание сертификата

Таким образом все `.csr` файлы будут находиться в одной отдельной папке.

### Шаг 2: Получение подписанных сертификатов

Отправьте файлы CSR из папки `csr/` в ваш центр сертификации (CA) для подписания. Этот процесс зависит от используемого CA и может включать:

- Загрузку CSR через веб-интерфейс CA
- Отправку CSR по электронной почте
- Использование API или CLI-инструментов CA
- Работу через корпоративную систему управления сертификатами

#### Требования к ответу от CA

После обработки вы должны получить от центра сертификации:

1. **Подписанные сертификаты узлов** (файлы `.crt`)
   - Имена файлов должны **точно совпадать** с именами CSR-файлов
   - Например: если CSR называется `static-node-1.ydb-cluster.com.csr`, то сертификат должен называться `static-node-1.ydb-cluster.com.crt`
   - Если имена отличаются, файлы нужно переименовать
   - Все сертификаты должны быть помещены в **одну папку**

2. **Файл ca.crt с полной цепочкой сертификатов CA**
   - **ОБЯЗАТЕЛЬНО:** Файл должен содержать **всю цепочку** сертификатов, а не только корневой сертификат
   - Если используется промежуточный CA, файл должен содержать сертификаты в правильном порядке:
     ```
     -----BEGIN CERTIFICATE-----
     [Промежуточный CA сертификат]
     -----END CERTIFICATE-----
     -----BEGIN CERTIFICATE-----
     [Корневой CA сертификат]
     -----END CERTIFICATE-----
     ```
   - Если используется только корневой CA без промежуточных, файл будет содержать один сертификат

#### Пример структуры папки с полученными сертификатами

```
certs/from-ca/
├── ca.crt                                    # Полная цепочка CA (обязательно!)
├── static-node-1.ydb-cluster.com.crt         # Имя совпадает с CSR
├── static-node-2.ydb-cluster.com.crt         # Имя совпадает с CSR
└── static-node-3.ydb-cluster.com.crt         # Имя совпадает с CSR
```

### Шаг 3: Размещение сертификатов

После получения подписанных сертификатов от CA, их нужно разложить по правильной структуре папок, которую ожидают Ansible-плейбуки для YDB. Для автоматизации этой задачи используется скрипт `ydb_arrange_certs.sh`. Запустите его, указав папку, в которой лежат готовые сертификаты и корневой сертификат:

```bash
./ydb_arrange_certs.sh -d certs/from-ca -c certs/from-ca/ca.crt
```

Скрипт автоматически скопирует сертификаты из одной папки по индивидуальным папкам для каждого узла и создает необходимые объединенные файлы. Это упрощает использование сертификатов с Ansible-плейбуками, которые ожидают определенную структуру папок.

**Параметры:**
- `-d` (обязательный) - Папка с подписанными сертификатами от CA
- `-c` (опциональный) - Путь к сертификату CA (если не указан, будет использован `ca.crt` из папки с сертификатами)

**Результат выполнения:**
- `nodes/<узел>/node.crt` - подписанный сертификат узла (скопирован из папки CA)
- `nodes/<узел>/web.pem` - объединенный файл (node.key + node.crt + ca.crt) для веб-интерфейса
- `nodes/ca.crt` - сертификат CA (или цепочка сертификатов) для всех узлов

### Шаг 4: Проверка сертификатов

Перед развертыванием рекомендуется проверить корректность сертификатов:

```bash
./ydb_verify_certs.sh
```

Скрипт автоматически проверит все узлы и выведет результаты проверки.

**Проверки, выполняемые скриптом:**
1. Соответствие закрытого ключа, CSR и сертификата
2. Подпись сертификата центром сертификации
3. Корректность структуры файла web.pem
4. Наличие расширений для SSL-клиента и SSL-сервера
5. Срок действия сертификатов (включая цепочку CA)
6. Валидация цепочки сертификатов
7. Проверка Subject Alternative Names (SAN)
8. Соответствие списку узлов из конфигурационного файла
9. Корректность формата PEM
10. Отсутствие дубликатов сертификатов

## Важная информация о Distinguished Name (DN)

### Назначение полей DN для авторизации

YDB использует поля Distinguished Name (DN) для авторизации узлов кластера.

**Важный принцип:** В конфигурации YDB не обязательно указывать все компоненты DN из сертификата. Достаточно указать те компоненты, которые однозначно идентифицируют узлы вашего кластера. Все компоненты, указанные в конфигурации YDB, должны присутствовать в Subject сертификата, но не все компоненты из Subject нужно указывать в конфигурации.

**Рекомендация:** Обычно достаточно указать один наиболее специфичный компонент, например, уникальный OU (Organizational Unit) для вашего кластера.

### Примеры конфигурации

#### Пример 1: Минимальная конфигурация (рекомендуется)

Если вы генерировали CSR с параметрами:
```bash
./ydb_generate_csr.sh -d "C=RU,ST=Moscow,O=MyCompany,OU=prod-ydb-cluster"
```

То в конфигурационном файле YDB (`config.yaml`) **достаточно указать только уникальный OU**:

```yaml
client_certificate_authorization:
  request_client_certificate: true
  client_certificate_definitions:
    - member_groups: ["databaseNodes@cert"]
      subject_terms:
        - short_name: "OU"
          values: ["prod-ydb-cluster"]
```

Это самый простой и рекомендуемый подход - используйте уникальное имя OU для каждого кластера.

#### Пример 2: DN с несколькими OU

Если вы генерировали CSR с несколькими OU:
```bash
./ydb_generate_csr.sh -d "O=Example Inc,OU=Engineering,OU=Database Infrastructure"
```

Вы можете указать только один самый специфичный OU:

```yaml
client_certificate_authorization:
  request_client_certificate: true
  client_certificate_definitions:
    - member_groups: ["databaseNodes@cert"]
      subject_terms:
        - short_name: "OU"
          values: ["Database Infrastructure"]
```

Или оба OU для более строгой проверки:

```yaml
client_certificate_authorization:
  request_client_certificate: true
  client_certificate_definitions:
    - member_groups: ["databaseNodes@cert"]
      subject_terms:
        - short_name: "OU"
          values: ["Engineering", "Database Infrastructure"]
```

#### Пример 3: Конфигурация с несколькими полями

Если это нужно, можно идентифицировать сертификаты по нескольким разным полям:
```bash
./ydb_generate_csr.sh -d "C=RU,ST=Moscow,O=MyCompany,OU=Database Team"
```

Конфигурация YDB:

```yaml
client_certificate_authorization:
  request_client_certificate: true
  client_certificate_definitions:
    - member_groups: ["databaseNodes@cert"]
      subject_terms:
        - short_name: "O"
          values: ["MyCompany"]
        - short_name: "OU"
          values: ["Database Team"]
```

В этом случае сертификат должен содержать **как минимум** указанные поля O и OU с точными значениями. Наличие дополнительных полей (C, ST) в сертификате не помешает авторизации.

**Важно:**
- Все поля, указанные в конфигурации YDB, должны присутствовать в сертификате с точными значениями
- Сертификат может содержать дополнительные поля DN, которые не указаны в конфигурации
- Рекомендуется использовать минимальный набор полей (обычно один уникальный OU) для упрощения управления

## Структура выходных файлов

После выполнения всех шагов в папке `nodes/` будет следующая структура:

```
nodes/
├── ca.crt                                    # Сертификат CA (или цепочка)
├── static-node-1.ydb-cluster.com/
│   ├── node.key                              # Закрытый ключ узла
│   ├── node.crt                              # Подписанный сертификат узла
│   ├── web.pem                               # Объединенный файл (key + crt + ca)
│   └── options.cnf                           # Конфигурация OpenSSL
├── static-node-2.ydb-cluster.com/
│   ├── node.key
│   ├── node.crt
│   ├── web.pem
│   └── options.cnf
└── static-node-3.ydb-cluster.com/
    ├── node.key
    ├── node.crt
    ├── web.pem
    └── options.cnf
```

---

## Сценарий 2: Генерация сертификатов в CA без использования CSR

Этот сценарий нужно использовать, если ваш удостоверяющий центр генерирует сертификаты самостоятельно, а не подписывает готовые CSR. В целом это более сложный путь, потому что УЦ должен самостоятельно создать сертификаты, удовлетворяющие требованиям ydb.

### Требования к сертификатам 

Центр сертификации должен предоставить сертификаты, соответствующие следующим требованиям:

#### 1. Distinguished Name (DN)

Сертификаты должны содержать DN с компонентами, которые будут использоваться для авторизации в YDB:

- **Обязательные поля:** Как минимум один Organizational Unit индивидуальный для кластера. Этот OU нужно будет указать в конфиге ydb (см 1 раздел)
- **Опцилнальные поля:** Все прочие поля, такие как C (Country), ST (State), L (Locality) и O (Organization) могут присутствовать. 
- **CN (Common Name):** Должен содержать имя узла (например, `static-node-1.ydb-cluster.com` или короткое имя `static-node-1`). Для ydb не важна эта компонента DN, но в целом ее наличие желательно.

Пример DN:
```
C=RU, ST=Moscow, O=MyCompany, OU=prod-ydb-cluster, CN=static-node-1.ydb-cluster.com
```

#### 2. Key Usage и Extended Key Usage

Сертификаты должны иметь правильное назначение:

**Key Usage:**
- Digital Signature
- Key Encipherment

**Extended Key Usage:**
- TLS Web Server Authentication (serverAuth)
- TLS Web Client Authentication (clientAuth)

Все четыре назначения обязательны!

#### 3. Subject Alternative Names (SAN)

Каждый сертификат должен содержать SAN с DNS-именами узла:

- Полное доменное имя узла (FQDN): `static-node-1.ydb-cluster.com`
- Короткое имя узла: `static-node-1`
- Дополнительные имена, если узел доступен по нескольким именам
- Если подключение к ydb будет происходить через балансировщик нагрузки или прокси-сервер, то его имя тоже нужно добавить

 IP адреса не обязательны, но их тоже можно добавить:

- IP адрес узла
- 127.0.0.1 позволит подключаться через SSH-тунели 

Пример SAN:
```
DNS:static-node-1
DNS:static-node-1.ydb-cluster.com
DNS:node1.internal
```

### Структура файлов от CA

Все файлы должны быть помещены в **одну папку** с правильными именами:

```
certs/from-ca/
├── ca.crt                                    # Полная цепочка CA (обязательно!)
├── static-node-1.ydb-cluster.com.crt         # Сертификат узла
├── static-node-1.ydb-cluster.com.key         # Закрытый ключ узла
├── static-node-2.ydb-cluster.com.crt
├── static-node-2.ydb-cluster.com.key
├── static-node-3.ydb-cluster.com.crt
└── static-node-3.ydb-cluster.com.key
```

**Важные требования к именам файлов:**

1. Имена файлов `.crt` и `.key` должны **точно совпадать** (кроме расширения)
2. Файлы `.key` должны содержать именно закрытые ключи отдельных узлов, а не ключ корневого или промежуточного сертификатов.
3. Имена должны соответствовать FQDN узлов из файла `ydb-ca-nodes.txt`
4. Файл `ca.crt` должен содержать **полную цепочку** сертификатов CA

### Пошаговая инструкция

#### Шаг 1: Подготовка списка узлов

Создайте файл `ydb-ca-nodes.txt` со списком узлов (см. раздел "Файл со списком узлов" выше).

#### Шаг 2: Передача требований в CA

Предоставьте центру сертификации:

1. **Список узлов** из файла `ydb-ca-nodes.txt`
2. **Требования к DN** (например: `C=RU,ST=Moscow,O=MyCompany,OU=prod-ydb-cluster`)
3. **Требования к SAN** для каждого узла (FQDN + короткое имя + дополнительные имена)
4. **Требования к Key Usage** (см. выше)

#### Шаг 3: Получение файлов от CA

Получите от CA:
- Сертификаты узлов (`.crt` файлы)
- Закрытые ключи узлов (`.key` файлы)
- Файл `ca.crt` с полной цепочкой сертификатов CA

Поместите все файлы в одну папку (например, `certs/from-ca/`).

#### Шаг 4: Размещение сертификатов и ключей

Используйте скрипт `ydb_arrange_certs.sh` с флагом `-k` для копирования сертификатов и закрытых ключей:

```bash
./ydb_arrange_certs.sh -d certs/from-ca -c certs/from-ca/ca.crt -k
```

**Параметры:**
- `-d` (обязательный) - Папка с сертификатами и ключами от CA
- `-c` (опциональный) - Путь к файлу ca.crt
- `-k` (обязательный для этого сценария) - Копировать закрытые ключи из папки CA

**Результат выполнения:**
- `nodes/<узел>/node.key` - закрытый ключ узла (скопирован из папки CA)
- `nodes/<узел>/node.crt` - подписанный сертификат узла
- `nodes/<узел>/web.pem` - объединенный файл (node.key + node.crt + ca.crt)
- `nodes/ca.crt` - сертификат CA (или цепочка сертификатов)

#### Шаг 5: Проверка сертификатов

Перед развертыванием обязательно проверьте корректность сертификатов:

```bash
./ydb_verify_certs.sh
```

Скрипт проверит все требования к сертификатам, включая DN, Key Usage, SAN и цепочку доверия.
При создании сертификатов без использования готовых csr-файлов этот шаг особенно важен, т.к. требования к сертификатам передаются в УЦ в неформализованом виде и вероятность их нарушения значительно выше.

---

## Использование сертификатов при развертывании через Ansible

Структура папок совместима с Ansible-плейбуками для установки YDB. Укажите путь к папке `nodes/` в файле `50-inventory.yaml`:

```yaml
all:
  vars:
    ydb_tls_dir: "/path/to/NEW_TLS/nodes"
```
